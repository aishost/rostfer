Окей — ниже **подробное ТЗ** под ваш стек «статический сайт + тонкий Python-бэкенд для форм», без кода. Формат — чтобы можно было отдать в Cursor/исполнителю и получить рабочий результат.

# 1) Цель и задачи

**Цель:** запустить быстрый SEO-дружелюбный сайт для продаж металлопроката с простым обновлением каталога из файла/выгрузки и сбором заявок.

**Ключевые задачи:**

* Главная (лендинг) с чётким УТП.
* Каталог: дерево категорий, страницы категорий, карточка товара.
* Лиды: форма обратной связи/заказа (отправка в БД + уведомления).
* SEO-основа: ЧПУ, микроразметка, sitemap/robots, мета-теги, OpenGraph.
* Конвейер обновления: «кладём файл → сайт переcобирается инкрементально».

# 2) Область работ (Scope)

Входит:

* Фронт: шаблоны страниц, верстка, состояние «пустые/нет в наличии».
* Билдер: генерация статических HTML + ассеты (картинки, css, js).
* Бэкенд: один API для форм, антиспам, логирование, уведомления.
* ETL: импорт каталога из CSV/XLSX/Google Sheets/1C-выгрузки.
* Деплой: конфигурация окружений, крон, атомарные релизы.
* Аналитика, базовые метрики, мониторинг.
  Не входит (опционально): личный кабинет, корзина/оплата, онлайн-поиск по складам, сложные фильтры по десяткам параметров.

# 3) Роли и артефакты

* **Заказчик/владелец продукта:** утверждает УТП, контент, структуру каталога.
* **Разработчик:** реализует ETL/билдер/бэкенд/верстку, настраивает деплой.
* **SEO-спец (может совмещаться):** мета-теги, тексты, перелинковка.
* **Артефакты:** репозиторий, .env.example, схема данных, макеты, чек-листы тестов, инструкции по эксплуатации.

# 4) Архитектура решения

* **Источник данных:** папка `/data/inbox` (CSV/XLSX) и/или Google Sheet (по API).
* **ETL:** нормализация, валидация, запись в PostgreSQL, отметка изменённых сущностей.
* **Билдер (SSG):** генерирует статические HTML по Jinja2-шаблонам (или аналог), создает sitemap/robots/JSON-LD, оптимизирует изображения (webp/avif), собирает css/js.
* **Хостинг статики:** Nginx (+CDN опционально).
* **API для форм:** FastAPI (или экв.) принимает POST, пишет в БД, шлёт уведомления (Telegram/email), возвращает JSON.
* **Триггеры обновления:** cron, ручной запуск; инкрементальная регенерация.
* **Логи/мониторинг:** access/error Nginx, логи API, алерты при падениях.

# 5) Нефункциональные требования

* **Производительность CWV:** LCP ≤ 2.0 c (десктоп), CLS ≤ 0.1, TBT ≤ 200 мс.
* **Время билда:** ≤ 3 мин при 5k SKU; инкремент ≤ 60 сек при 100 изменениях.
* **Надёжность:** безоткатный деплой (atomic), откат одной командой.
* **Безопасность:** HTTPS, rate-limit API, honeypot, валидация входа, секреты в .env.
* **Доступность (a11y):** семантическая вёрстка, контраст ≥ WCAG AA, alt у медиа.
* **Масштаб:** до 10k SKU без серверного поиска; свыше — план расширения (см. §17).

# 6) Среда и стек

* **Язык:** Python 3.11+.
* **БД:** PostgreSQL 15+.
* **Шаблоны:** Jinja2/экв.
* **CSS:** без utility-фреймворков; PostCSS/SCSS допустимы; BEM-подход.
* **Веб-сервер:** Nginx (HTTP/2, Brotli, кэширование).
* **CI/CD:** GitHub Actions (или аналог) с atomic-deploy.
* **ОС/хостинг:** Ubuntu LTS, systemd-сервисы для API/крона.

# 7) Структура каталогов репозитория

* `/templates/` — шаблоны страниц: `index.html`, `category.html`, `product.html`, `page.html`.
* `/content/` — тексты/баннеры/иконки, markdown для статических страниц (о компании, доставка, контакты).
* `/assets/` — css, js, шрифты, сурсы изображений.
  * `/assets/img/categories/` — изображения категорий (по `slug`).
  * `/assets/img/products/` — изображения товаров (по `sku`/`slug`).
* `/dist/` — собранный сайт (не в git).
* `/data/inbox/` — входные файлы каталога.
* `/data/archive/` — архив загруженных файлов с датами.
* `/data/uploads/` — входящие изображения от контент‑менеджера (категории/товары), обрабатываются ETL.
* `/scripts/` — ETL/Build/Deploy сценарии.
* `/infra/` — примеры конфигов Nginx, systemd, cron (без секретов).
* `/docs/` — this ТЗ, чек-листы, инструкции.

# 8) Сущности и поля (данные)

**Категория:**

* `id`, `name`, `slug`, `parent_id`, `seo_title`, `seo_description`, `h1`, `intro_text`, `sort_order`, `is_active`.

**Товар:**

* `id`, `sku`, `slug`, `category_id`, `name`, `brand`, `spec` (JSON характеристик: ГОСТ, размер, тип, покрытие, длина и т.д.),
  `price`, `old_price`, `currency`, `in_stock`, `min_order`, `unit` (м/тн/шт), `weight_per_unit`,
  `badges` (новинка/хит/скидка), `short_desc`, `long_desc`, `meta_title`, `meta_description`, `updated_at`, `is_active`.

**Изображения:**

* `product_id`, `url`, `alt`, `is_primary`, `sort_order`, источники (если CDN/MinIO).

**Медиа (категории/товары):**

* Категория: поле `image_url?` (основное изображение категории, относительный URL `/assets/img/categories/<slug>.webp`).
* Товар: отдельная таблица `product_images` (см. выше), минимум одно первичное изображение; для упрощения MVP допускается `product.image_url?`.
* Источник медиа: файлы из `/data/uploads/` (см. §9 Import), ETL копирует/конвертирует в `/assets/img/...` и проставляет ссылки.

**SEO-сопутствующие:**

* canonical (на уровне категорий/товаров), breadcrumbs.

**Лиды (заказы/обратная связь):**

* `id`, `created_at`, `name`, `phone`, `email`, `message`, `product_id?`, `source`, `utm_*`, `ip`, `user_agent`, `status`.

# 9) Источник каталога и правила импорта

* **Форматы:** CSV/XLSX; один товар — одна строка; обязательные поля: `sku`, `name`, `category`, `price`, `in_stock`. Поле `slug` опционально (см. ниже).
* **Валидация:** типы, диапазоны (цена ≥ 0), обязательность, уникальность `sku`; контроль уникальности `slug` в своей сущности.
* **Нормализация:** маппинг «человекочитаемой» категории к `category_id`; обрезка пробелов, приведение длины.
* **Slug‑генерация (авто, если пусто):**
  * Транслит RU→EN, только строчные латиница/цифры/дефисы, множественные пробелы → один `-`, трим дефисы по краям.
  * Для товаров берём из `name` или `sku` (если имя короткое/техническое). Для категорий — из `name`.
  * Разрешение коллизий: если `slug` занят — добавляем `-2`, `-3`, ... до уникальности.
  * Смены slug фиксируем в таблице `redirects` с типом сущности (`category|product`) для 301.
* **Медиа‑ингест (картинки):**
  * Вход: `/data/uploads/categories/<slug>.{jpg,png,webp}` и `/data/uploads/products/<sku>/*.{jpg,png,webp}`.
  * ETL: конвертация в WebP (и/или AVIF, опц.), минимальная ширина 1200px для карточек, создание превью 600px; запись относительных ссылок в `image_url`/`product_images`.
  * Выход: `/assets/img/categories/<slug>.webp`, `/assets/img/products/<sku>/<basename>.webp`.
  * Отсутствуют файлы → подставляется дефолт: `/assets/img/placeholders/category.webp` или `product.webp`.
* **Изменения:** новая строка → create; изменённые поля → update; исчезнувшие `sku` → `is_active=false` + 410/редирект (см. §14).
* **Отчёт импорта:** кол-во создано/обновлено/скрыто/ошибки; лог-файл; счётчики обработанных изображений.

# 10) Страницы и маршруты

**Главная** `/`

* Блок УТП (заголовок, подзаголовок, основные преимущества).
* Топ-категории (≤ 8), баннер/герой, CTA (кнопка «Оставить заявку»).
* Превью особенностей: доставка/сертификаты/оплата; логотипы партнёров (если есть).
* Блок «популярные товары» (ручной выбор/авто по продажам).

**Категория** `/<category-slug>/[page-N]/`

* H1, интро-текст, список подкатегорий.
* Список товаров (карточки: название, ключевая спецификация, цена/единица, «в наличии», CTA «Запросить счёт/Заказать»).
* Пагинация (canonical на первую; `rel=prev/next`).
* Хлебные крошки.

**Товар** `/product/<product-slug>/`

* Галерея изображений (основное + превью), H1, цена/единица, наличие, min-order.
* Ключевые характеристики (таблица), подробное описание.
* Блок «Документы/ГОСТ/сертификаты» (если есть).
* CTA: кнопка/форма «Запросить счёт» с привязкой к product\_id.
* Блок «Похожие товары» (по категории/спецификации).

**Статические страницы** `/about/`, `/contacts/`, `/privacy/`, `/terms/` — markdown-контент.

**Служебные**

* `sitemap.xml`, `robots.txt`, `404.html`, `410.html`.
* `feed.json` (новые товары/обновления, опционально).

Примечание: директории без `.html` (используется `index.html`), обработка на уровне билда и Nginx (см. §27).

# 11) SEO-требования

* **ЧПУ:** см. маршруты выше; строчные, дефисы, транслит.
* **Метатеги:** title ≤ 60 симв, description 140–160; формулы генерации из полей.
* **H-иерархия:** 1×H1 на страницу (из `h1`/`name`), далее H2/H3 по блокам.
* **Canonical:** на страницы категорий, первая страница без `/page-1/`.
* **Микроразметка (JSON-LD):**

  * `BreadcrumbList` для всех категорий/товаров;
  * `Product` + `Offer` (price, priceCurrency, availability, url, sku);
  * `Organization` на главной.
* **OG/Twitter:** `og:title`, `og:description`, `og:image` (1200×630), `og:type`.
* **sitemap.xml:** все indexable URLs; авто-обновление; lastmod.
* **robots.txt:** Allow: `/`, Sitemap: полный URL; Disallow: служебные/параметры.
* **Внутренняя перелинковка:** из карточки — на категорию/похожие.
* **Скорость:** критический CSS inline на главной и карточке, lazy-loading изображений, `preload` шрифтов.

# 12) UI/UX-требования

* Чистая сетка, BEM-классы, адаптив 360–1440+.
* Кнопки/ссылки размер ≥ 44×44 px на мобильных.
* Формы: минимальное количество полей (Имя, Телефон, Email опционально, Комментарий).
* Стейт «нет в наличии»: чёткая индикация, CTA «Оставить запрос/Уточнить сроки».
* Сообщения об ошибках/успехе: кратко, по делу.

# 13) Формы и антиспам

* Поля: `name`, `phone` (маска + международный формат), `email?`, `message`, `product_id?`, `consent`.
* Антиспам: скрытое honeypot-поле, таймер заполнения, rate-limit по IP/UA.
* Ответ API: JSON c статусом и текстом пользователю; на фронте — «спасибо» без перезагрузки.
* Уведомления: Telegram канал/чат и/или email (SMTP); шаблон уведомления с UTM и referrer.

# 14) Редиректы, 404/410 и снятие с индекса

* Удалённые товары: отдаём **410** на старые URL 30 дней, затем постоянный редирект на категорию (или оставляем 410).
* Переезд slug: 301 с прежнего на новый, список редиректов хранить в таблице `redirects(entity_type, entity_id, old_slug, new_slug, created_at)`; билдер генерирует правила в `dist/_redirects` (если используется) или предоставляет карту для Nginx.
* 404 страница: с поиском по сайту (если есть) и ссылками на категории.

# 15) Кэширование и заголовки

* HTML: короткий TTL (no-store для динамического ответа формы; статические HTML — `max-age=300` + `ETag`).
* Ассеты: `Cache-Control: public, max-age=31536000, immutable`.
* Изображения: `ETag/Last-Modified`.
* Gzip/Brotli включены; HTTP/2.

# 16) Аналитика и события

* Счётчики: Яндекс.Метрика, GA4 (оба, если требуется).
* События: `view_item`, `lead_submit`, `click_phone`, `click_email`, `cta_click`, `scroll_depth` (25/50/75), `outbound_link`.
* UTM-метки: сохранять в локальном storage и подставлять в форму.

# 17) План масштабирования (после MVP)

* До \~10k SKU — статик + Pagefind/Lunr (клиентский индекс).
* > 10k SKU или сложные фасеты — выделенный эндпоинт `/search` (Postgres `tsvector`), генерировать HTML сниппеты из JSON-ответа на клиенте (без индексации страниц поиска).
* Вынос изображений на CDN/облачное хранилище, генерация превью на этапе билда.

# 18) Конвейер сборки и деплой

* **Импорт:** по cron (например, каждые 30 мин) проверять `/data/inbox`. Новый файл → парс, валид, запись в БД → отчёт.
* **Build:** запуск по крону и вручную; инкремент по списку изменённых `id` + обязательная пересборка затронутых страниц (карточка, её категория, пагинация, sitemap). Обработка изображений (конвертация/копирование) на этапе билда/ETL.
* **Деплой:** сборка в `/dist_tmp/` → проверка → `ln -sfn` на `/dist/` → `nginx -s reload`. Откат: переключение симлинка на предыдущую сборку.
* **Секреты:** в `.env` (не коммитить), доступы ограничить, ротация паролей.

# 26) PostgreSQL: схема данных (DDL‑эскиз)

```sql
-- Справочник категорий
create table categories (
  id               bigserial primary key,
  parent_id        bigint references categories(id) on delete set null,
  name             text not null,
  slug             text not null unique,
  seo_title        text,
  seo_description  text,
  h1               text,
  intro_text       text,
  sort_order       int default 0,
  image_url        text,
  is_active        boolean not null default true
);

-- Товары
create table products (
  id               bigserial primary key,
  sku              text not null unique,
  slug             text not null unique,
  category_id      bigint references categories(id) on delete set null,
  name             text not null,
  brand            text,
  spec             jsonb not null default '{}',
  price            numeric(14,2),
  old_price        numeric(14,2),
  currency         text default 'RUB',
  in_stock         boolean not null default true,
  min_order        numeric(14,3),
  unit             text,
  weight_per_unit  numeric(14,3),
  badges           text[],
  short_desc       text,
  long_desc        text,
  meta_title       text,
  meta_description text,
  updated_at       timestamptz not null default now(),
  is_active        boolean not null default true
);
create index products_category_idx on products(category_id);
create index products_updated_idx on products(updated_at);

-- Изображения товара
create table product_images (
  id         bigserial primary key,
  product_id bigint not null references products(id) on delete cascade,
  url        text not null,
  alt        text,
  is_primary boolean not null default false,
  sort_order int not null default 0
);
create index product_images_product_idx on product_images(product_id);

-- Редиректы по смене slug
create table redirects (
  id           bigserial primary key,
  entity_type  text not null check (entity_type in ('category','product')),
  entity_id    bigint not null,
  old_slug     text not null,
  new_slug     text not null,
  created_at   timestamptz not null default now()
);
create unique index redirects_unique_old on redirects(entity_type, old_slug);

-- Лиды (формы)
create table leads (
  id           bigserial primary key,
  created_at   timestamptz not null default now(),
  name         text,
  phone        text not null,
  email        text,
  message      text,
  product_id   bigint references products(id),
  source       text,
  utm          jsonb,
  ip           inet,
  user_agent   text,
  status       text default 'new'
);
```

# 27) URL‑политика и Nginx

* Все страницы отдаются по адресам с завершающим `/` без `.html`. В `dist/` используется `index.html` в соответствующих директориях.
* Nginx: включить `try_files $uri $uri/ /index.html;` для статики и маппинг 404/410 (по списку из ETL).
* Категории: `/<category-slug>/[page-N]/` (canonical на первую страницу).
* Товары: `/p/<product-slug>/` (единый канонический URL вне зависимости от категории).

# 28) Инкрементальный билд и пересборка

* Триггер пересборки категории при изменении любой карточки товара в ней.
* Пересборка `sitemap.xml` по списку изменённых URL; `lastmod` = `updated_at`.
* Перегенерация миниатюр/превью изображений только для затронутых SKU/категорий.

# 19) Логи, мониторинг, алерты

* **ETL/Build:** лог-файлы с уровнями INFO/WARN/ERROR и итоговым отчётом.
* **API:** структурированные логи запросов/ошибок, masked PII.
* **Nginx:** access/error с ретеншном 30 дней, ротация.
* **Алерты:** при падении API, росте 5xx, сбое импорта, росте ошибок формы.
* **Метрики:** время билда, кол-во изменённых страниц, скорость ответа API p95.

# 20) Контент и редакторка

* Главная: заголовок УТП, 3–6 буллетов преимуществ, фото/герой-баннер, CTA.
* Категории/товары: тексты для SEO-блоков (intro, FAQ опционально), alt к изображениям.
* Юр-страницы: Политика конфиденциальности, Условия использования (минимум).

# 21) Юзкейс-потоки (Acceptance)

1. **Пользователь** открывает главную → видит УТП и CTA → переходит в категорию → карточку товара → отправляет форму → получает «спасибо», менеджер — уведомление в Telegram/email.
2. **Контент-менеджер** кладёт XLSX в `/data/inbox` → отчёт импорта: «создано/обновлено/скрыто/ошибки» → изменения опубликованы.
3. **SEO-спец** задаёт `meta_title/description` в источнике/БД → билд → проверяет в исходнике страницы и в SERP (через сниппет-тулзы).

# 22) Критерии приёмки (Checklist)

* [ ] Главная, категория, карточка, статические страницы корректно отображаются на 360/768/1280/1440.
* [ ] Валидация формы (пустые поля, неверный телефон/почта) работает; сообщения понятны.
* [ ] Лид уходит в БД, приходит уведомление Telegram/email; в логе — запись.
* [ ] `sitemap.xml` содержит все индексируемые URL, `robots.txt` валиден.
* [ ] JSON-LD валиден (Rich Results Test), `Product/Offer/BreadcrumbList` присутствуют.
* [ ] Canonical корректен, пагинация настроена, 404/410 выданы по правилам.
* [ ] CWV: LCP ≤ 2.0 c на тестовых страницах (десктоп), CLS ≤ 0.1.
* [ ] Билд повторяемый, деплой атомарный, откат работает.
* [ ] Логи ротируются, алерты срабатывают при фейле импорта/API.
* [ ] Документация по эксплуатации/обновлению актуальна.

# 23) Тест-план (минимум)

* **Функциональные:** отправка формы (валид/невалид), переходы, хлебные крошки, пагинация, редиректы 301/410.
* **SEO-тех:** мета-теги и заголовки, canonical, OG, JSON-LD, sitemap, robots.
* **Перф:** Lighthouse ≥ 90 (Performance/Best Practices/SEO на десктопе), размер HTML ≤ 200 KB без картинок.
* **Импорт:** корректная обработка новых/обновлённых/удалённых SKU, отчёты.
* **Безопасность:** XSS в формах (обезвреживание), CSRF не требуется для чистого API при CORS=off; rate-limit; скрытие серверных версий.

# 24) Эксплуатация и регламенты

* **Импорт каталога:** форматы, обязательные поля, расписание, кто ответственный.
* **Публикация:** кто апрувит контент/изменения редиректов.
* **Резервные копии:** БД (ежедневно, 7/30), предыдущие билды (N=5).
* **Инциденты:** регламент реакции (SLA ответа, кого пинговать, где смотреть логи).

# 25) Будущие расширения (roadmap, опционально)

* Серверный поиск/фасеты, прайс-листы в PDF на лету, мультиязык, интеграция с CRM, выгрузка в маркетплейсы, собственный кабинет партнёра.

---

Если нужно, могу на этой базе сделать короткую «**карточку задач**» для трекера (эпики → задачи → критерии «Definition of Done») и шаблон источника каталога (описание полей и допустимых значений) — тоже без кода.

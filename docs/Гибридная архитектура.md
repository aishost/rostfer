# Гибридная архитектура РостФеррум

Новая архитектура разделяет статические страницы (категории) и динамические (товары) для оптимизации производительности с большим каталогом (500,000+ товаров).

## Архитектура

### Статические страницы (генерируются build.py)
- Главная страница: `/`
- О компании: `/about/`
- Категории каталога: `/catalog/{slug}/`
- Служебные страницы: `/privacy/`, `/terms/`, `/404.html`
- Статические ресурсы: `/assets/`

### Динамические страницы (Flask приложение)
- Страницы товаров: `/product/{slug}/`
- API endpoints: `/api/` (если необходимо)

## Компоненты

### 1. Модифицированный build.py
- Генерирует только категории (650 страниц)
- Исключает товары из генерации
- Время сборки сокращено с часов до минут
- Не включает товары в статический sitemap

### 2. FastAPI приложение (scripts/api.py)
- Обрабатывает запросы к `/product/{slug}/` и `/api/*`
- Использует те же шаблоны и логику, что и build.py
- Подключается к той же БД (PostgreSQL)
- Поддерживает кэширование на уровне Nginx
- Единое приложение для API и страниц товаров

### 3. Nginx конфигурация
- Проксирует `/product/*` и `/api/*` на FastAPI (порт 8000)
- Отдает статические файлы из `dist/`
- Настроено кэширование и сжатие

## Развертывание

### Шаг 1: Установка зависимостей
```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
# или venv\Scripts\activate  # Windows
pip install -r requirements.txt
```

### Шаг 2: Настройка переменных окружения
```bash
# В .env файле или systemd service
DATABASE_URL=postgresql://rostferrum_user:password@localhost/rostferrum
```

### Шаг 3: Установка systemd сервиса
```bash
sudo cp deploy/rostferrum-products.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable rostferrum-products
sudo systemctl start rostferrum-products
```

### Шаг 4: Настройка Nginx
```bash
sudo cp nginx/rostferrum.conf /etc/nginx/sites-available/
sudo ln -s /etc/nginx/sites-available/rostferrum.conf /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### Шаг 5: Сборка статических страниц
```bash
python scripts/build.py --force-rebuild
```

## Преимущества

✅ **Быстрая сборка**: только 650 категорий вместо 500,000 товаров  
✅ **SEO-дружественность**: уникальные URL для каждого товара  
✅ **Масштабируемость**: Flask может работать в кластере  
✅ **Простота отладки**: знакомые технологии  
✅ **Кэширование**: на уровне Nginx и приложения  
✅ **Независимость**: статика работает даже при падении Flask  

## Мониторинг

### Проверка статуса сервисов
```bash
# FastAPI приложение
sudo systemctl status rostferrum-products

# Nginx
sudo systemctl status nginx

# Логи FastAPI
sudo journalctl -u rostferrum-products -f

# Логи Nginx
sudo tail -f /var/log/nginx/rostferrum_error.log
```

### Тестирование
```bash
# Статическая страница (Nginx)
curl -I http://rostferrum.ru/

# Динамическая страница (FastAPI через Nginx)
curl -I http://rostferrum.ru/product/some-product-slug/

# Прямое обращение к FastAPI
curl -I http://127.0.0.1:8000/product/some-product-slug/

# API endpoints
curl -I http://127.0.0.1:8000/api/lead
```

## Оптимизация

### Кэширование
- Nginx proxy_cache для часто запрашиваемых товаров
- Redis для кэширования между экземплярами FastAPI
- In-memory кэширование в FastAPI

### Масштабирование
- Несколько воркеров uvicorn (уже настроено в systemd)
- Горизонтальное масштабирование FastAPI за load balancer
- CDN для статических ресурсов

### Мониторинг производительности
- New Relic / Prometheus для мониторинга FastAPI
- Nginx access logs для анализа трафика
- Database connection pooling в PostgreSQL

## Будущие улучшения

1. **Кэширование популярных товаров** как статические страницы
2. **A/B тестирование** шаблонов товаров
3. **Ленивая генерация** статических страниц по запросу
4. **Микросервисная архитектура** с отдельными сервисами

## Rollback план

В случае проблем можно быстро вернуться к полностью статической генерации:

1. Восстановить оригинальный `build.py`
2. Запустить полную сборку: `python scripts/build.py --force-rebuild`
3. Изменить Nginx конфигурацию на полностью статическую
4. Отключить Flask сервис

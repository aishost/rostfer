# Билд проекта: режимы и рекомендации

Этот проект генерирует статический сайт в директорию `dist/` с помощью Jinja2-шаблонов и данных из БД.

## Источники данных
- Переменная окружения `DATABASE_URL` (PostgreSQL или SQLite):
  - PostgreSQL: `postgresql://user:pass@host:port/dbname`
  - SQLite: `sqlite:///data/catalog.db`
- При недоступности БД сборщик использует заглушки (для базовой проверki верстки).

## Основные команды
- Обычная сборка:
  ```powershell
  python scripts/build.py
  ```
- Полная пересборка (очистка кэшей и страниц каталога/товаров):
  ```powershell
  python scripts/build.py --force-rebuild
  ```
- Отключить кэш байткода Jinja (перекомпилировать шаблоны):
  ```powershell
  python scripts/build.py --no-bcc
  ```
- Последовательный рендер (без пула процессов) — удобно для отладки/Windows:
  ```powershell
  python scripts/build.py --serial
  ```
- Комбинирование флагов (рекомендуется при изменении шаблонов):
  ```powershell
  python scripts/build.py --force-rebuild --no-bcc
  # при необходимости
  python scripts/build.py --force-rebuild --no-bcc --serial
  ```

## Что делают флаги
- `--force-rebuild`:
  - удаляет `.jinja_cache/`
  - удаляет `dist/catalog/` и `dist/product/`
  - затем пересобирает страницы
- `--no-bcc`:
  - отключает Jinja bytecode cache
  - включает `auto_reload=True` для гарантированной перекомпиляции шаблонов
- `--serial`:
  - рендерит все страницы последовательно (без `ProcessPoolExecutor`)
  - полезно при отладке и на Windows, где параллелизм может маскировать исключения

Альтернативно флаги можно задать переменными окружения:
- `ROSTFERRUM_DISABLE_BCC=1` — аналог `--no-bcc`
- `ROSTFERRUM_SERIAL=1` — аналог `--serial`
- `ROSTFERRUM_BUILD_WORKERS=<N>` — количество воркеров при параллельном рендере

## Поведение сборщика
- Статика копируется из `assets/` в `dist/assets/` (включая `no-photo.png`).
- Шаблоны Jinja рендерятся в:
  - `dist/index.html`, `dist/about/index.html`
  - `dist/catalog/…/index.html` (+ пагинация `page-N/`)
  - `dist/product/<slug>/index.html`
- Оптимизация записи файлов: используется `write_if_changed`, чтобы не перезаписывать неизменившиеся файлы. Поэтому для применения правок в шаблонах используйте `--force-rebuild` (очищает каталоги) и/или `--no-bcc` (перекомпилирует шаблоны).

## Частые вопросы
- «Изменил partial, но в категориях нет изменений» — запустите:
  ```powershell
  python scripts/build.py --force-rebuild --no-bcc
  ```
- «На Windows не вижу причину падения» — используйте последовательный режим и, при необходимости, лог в файл:
  ```powershell
  python scripts/build.py --serial 2>&1 | Tee-Object -FilePath build.log
  ```

## CI/CD
В GitHub Actions по умолчанию запускается полная пересборка шаблонов (см. `.github/workflows/deploy.yml`).


